# common/utils_spy.py
import os
import pandas as pd
import pandas_market_calendars as mcal
from datetime import time as dtime
from ta.trend import SMAIndicator
import subprocess
import streamlit as st


def get_latest_nyse_trading_day(today=None):
    nyse = mcal.get_calendar("NYSE")
    if today is None:
        today = pd.Timestamp.today().normalize()
    sched = nyse.schedule(
        start_date=today - pd.Timedelta(days=7),
        end_date=today + pd.Timedelta(days=1),
    )
    valid_days = sched.index.normalize()
    return valid_days[valid_days <= today].max()


def get_spy_data_cached(folder="data_cache"):
    """
    SPY.csv 繧偵く繝｣繝・す繝･縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ縲∝商縺代ｌ縺ｰ recover_spy_cache.py 繧貞他繧薙〒譖ｴ譁ｰ縲・
    """
    path = os.path.join(folder, "SPY.csv")
    if os.path.exists(path):
        try:
            df = pd.read_csv(path, parse_dates=["Date"])
            if "Date" not in df.columns:
                return None
            df.set_index("Date", inplace=True)
            df = df.sort_index()
            return df
        except Exception as e:
            st.error(f"笶・SPY隱ｭ縺ｿ霎ｼ縺ｿ螟ｱ謨・ {e}")
            return None
    else:
        st.error("笶・SPY.csv 縺悟ｭ伜惠縺励∪縺帙ｓ")
        return None


def get_spy_with_indicators(spy_df=None):
    """
    SPY 縺ｫ SMA100 / SMA200 繧剃ｻ倅ｸ趣ｼ医ヵ繧｣繝ｫ繧ｿ繝ｼ縺ｯ謌ｦ逡･蛛ｴ縺ｧ蛻､螳壹☆繧具ｼ・
    """
    if spy_df is None:
        spy_df = get_spy_data_cached()
    if spy_df is not None and not spy_df.empty:
        spy_df["SMA100"] = SMAIndicator(spy_df["Close"], window=100).sma_indicator()
        spy_df["SMA200"] = SMAIndicator(spy_df["Close"], window=200).sma_indicator()
    return spy_df

