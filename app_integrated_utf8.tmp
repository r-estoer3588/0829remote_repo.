from __future__ import annotations

import streamlit as st
import common.ui_patch  # noqa: F401
from pathlib import Path
from common.i18n import tr, load_translations_from_dir, language_selector

from config.settings import get_settings
from common.logging_utils import setup_logging
from common.notifier import Notifier
from common.utils_spy import get_spy_data_cached
from common.ui_tabs import render_integrated_tab, render_batch_tab

# 螟夜Κ鄙ｻ險ｳ繧定ｪｭ縺ｿ霎ｼ繧・井ｻｻ諢上・襍ｷ蜍墓凾縺ｫ荳蠎ｦ・・
load_translations_from_dir(Path(__file__).parent / "translations")
# 險隱樣∈謚槭ｒ陦ｨ遉ｺ
language_selector()


def main() -> None:
    st.set_page_config(page_title="Trading Systems 1-7 (Integrated)", layout="wide")

    settings = get_settings(create_dirs=True)
    logger = setup_logging(settings)
    logger.info("app_integrated start")
    notifier = Notifier(platform="auto")

    st.title(tr("Trading Systems Integrated UI"))
    with st.expander(tr("settings"), expanded=False):
        col1, col2, col3 = st.columns(3)
        with col1:
            st.write("RESULTS_DIR:", str(settings.RESULTS_DIR))
            st.write("LOGS_DIR:", str(settings.LOGS_DIR))
        with col2:
            st.write("DATA_CACHE_DIR:", str(settings.DATA_CACHE_DIR))
            st.write("THREADS:", settings.THREADS_DEFAULT)
        with col3:
            st.write("DEFAULT CAPITAL:", settings.ui.default_capital)
            st.write("LOG LEVEL:", settings.logging.level)

    tabs = st.tabs([tr("Integrated"), tr("Batch")] + [f"System{i}" for i in range(1, 8)])

    with tabs[0]:
        render_integrated_tab(settings, notifier)

    with tabs[1]:
        render_batch_tab(settings, logger)

    system_tabs = tabs[2:]
    for sys_idx, tab in enumerate(system_tabs, start=1):
        with tab:
            sys_name = f"System{sys_idx}"
            st.subheader(f"{sys_name} backtest")
            try:
                app_mod = __import__(f"app_system{sys_idx}")
                if sys_idx == 1:
                    spy_df = get_spy_data_cached()
                    app_mod.run_tab(spy_df=spy_df)
                else:
                    app_mod.run_tab()
            except Exception as e:  # noqa: BLE001
                logger.exception("%s tab error", sys_name)
                st.exception(e)


if __name__ == "__main__":
    main()
