import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from collections import defaultdict
import streamlit as st


def generate_holding_matrix(
    results_df: pd.DataFrame,
    trade_progress_callback=None,
    matrix_progress_callback=None,
) -> pd.DataFrame:
    holding_dict = defaultdict(set)
    all_trades = list(results_df.iterrows())
    total_trades = len(all_trades)

    # 繝輔ぉ繝ｼ繧ｺ1: 繝医Ξ繝ｼ繝牙・逅・
    for i, (_, row) in enumerate(all_trades, 1):
        current_date = pd.to_datetime(row["entry_date"])
        end_date = pd.to_datetime(row["exit_date"])
        while current_date <= end_date:
            holding_dict[current_date.date()].add(row["symbol"])
            current_date += pd.Timedelta(days=1)

        if trade_progress_callback and (i % 10 == 0 or i == total_trades):
            trade_progress_callback(i, total_trades)

    # 繝輔ぉ繝ｼ繧ｺ2: 繝槭ヨ繝ｪ繧ｯ繧ｹ逕滓・
    all_dates = sorted(holding_dict.keys())
    all_symbols = sorted(set(results_df["symbol"].unique()))
    holding_matrix = pd.DataFrame(index=all_dates, columns=all_symbols)

    total_steps = len(all_dates)
    for j, date in enumerate(all_dates, 1):
        for sym in all_symbols:
            holding_matrix.loc[date, sym] = 1 if sym in holding_dict[date] else 0

        if matrix_progress_callback:
            ratio = j / total_steps
            # 1%騾ｲ繧薙□繧ｿ繧､繝溘Φ繧ｰ or 譛蠕後・蜃ｦ逅・〒譖ｴ譁ｰ
            if int(ratio * 100) != int((j - 1) / total_steps * 100) or j == total_steps:
                matrix_progress_callback(j, total_steps)
    return holding_matrix.fillna(0).astype(int)


def display_holding_heatmap(
    matrix: pd.DataFrame, title: str = "譌･蛻･菫晄怏繝偵・繝医・繝・・"
) -> None:
    """
    Streamlit縺ｧ菫晄怏驫俶氛縺ｮ繝偵・繝医・繝・・繧定｡ｨ遉ｺ縲・
    - matrix: generate_holding_matrix縺ｮ蜃ｺ蜉・
    - title: 陦ｨ遉ｺ繧ｿ繧､繝医Ν
    """
    st.subheader(title)

    # 陦ｨ遉ｺ陦梧焚縺悟､壹＞蝣ｴ蜷医・蛻ｶ髯撰ｼ井ｾ・ 譛螟ｧ100陦鯉ｼ・
    max_rows = 100
    if len(matrix) > max_rows:
        st.info(f"陦ｨ遉ｺ陦梧焚繧貞宛髯蝉ｸｭ・域怙譁ｰ{max_rows}譌･蛻・ｼ・)
        matrix = matrix.tail(max_rows)

    fig, ax = plt.subplots(figsize=(12, max(4, len(matrix) // 3)))
    sns.heatmap(matrix, cmap="Greens", cbar=False, linewidths=0.5, linecolor="gray")
    ax.set_xlabel("驫俶氛")
    ax.set_ylabel("譌･莉・)
    ax.set_title(title)
    st.pyplot(fig)


def download_holding_csv(
    matrix: pd.DataFrame, filename: str = "holding_status.csv"
) -> None:
    """
    菫晄怏驫俶氛縺ｮ驕ｷ遘ｻ繧辰SV蠖｢蠑上〒繝繧ｦ繝ｳ繝ｭ繝ｼ繝画署萓帙・
    """
    csv = matrix.to_csv().encode("utf-8")
    st.download_button(
        "菫晄怏驫俶氛縺ｮ驕ｷ遘ｻ繧辰SV縺ｧ菫晏ｭ・, data=csv, file_name=filename, mime="text/csv"
    )

