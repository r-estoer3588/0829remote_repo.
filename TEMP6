from __future__ import annotations

import streamlit as st
import common.ui_patch  # noqa: F401

from config.settings import get_settings
from common.logging_utils import setup_logging
from common.performance_summary import summarize as summarize_perf
from common.ui_bridge import (
    prepare_backtest_data_ui as _prepare_ui,
    run_backtest_with_logging_ui as _run_ui,
)
from common.utils_spy import get_spy_data_cached
from tickers_loader import get_all_tickers
from common.ui_manager import UIManager


def _show_sys_result(df, capital):
    if df is None or getattr(df, "empty", True):
        st.info("no trades")
        return
    summary, _ = summarize_perf(df, capital)
    d = summary.to_dict()
    cols = st.columns(6)
    cols[0].metric("trades", d.get("trades"))
    cols[1].metric("total pnl", f"{d.get('total_return', 0):.2f}")
    cols[2].metric("win(%)", f"{d.get('win_rate', 0):.2f}")
    cols[3].metric("PF", f"{d.get('profit_factor', 0):.2f}")
    cols[4].metric("Sharpe", f"{d.get('sharpe', 0):.2f}")
    cols[5].metric("MDD", f"{d.get('max_drawdown', 0):.2f}")
    st.dataframe(df)


def main():
    st.set_page_config(page_title="Trading Systems 1-7 (Integrated)", layout="wide")

    settings = get_settings(create_dirs=True)
    logger = setup_logging(settings)
    logger.info("app_integrated start")

    st.title("Trading Systems Integrated UI")
    with st.expander("settings", expanded=False):
        col1, col2, col3 = st.columns(3)
        with col1:
            st.write("RESULTS_DIR:", str(settings.RESULTS_DIR))
            st.write("LOGS_DIR:", str(settings.LOGS_DIR))
        with col2:
            st.write("DATA_CACHE_DIR:", str(settings.DATA_CACHE_DIR))
            st.write("THREADS:", settings.THREADS_DEFAULT)
        with col3:
            st.write("DEFAULT CAPITAL:", settings.ui.default_capital)
            st.write("LOG LEVEL:", settings.logging.level)

    tabs = st.tabs(["Batch"] + [f"System{i}" for i in range(1, 8)])

    # Batch run tab
    with tabs[0]:
        st.subheader("Batch Backtest / Summary")
        mode = st.radio(
            "mode",
            ["Backtest", "Future signals (coming soon)"],
            index=0,
            horizontal=True,
            key="batch_mode",
        )
        capital = st.number_input("capital (USD)", min_value=1000, value=int(settings.ui.default_capital), step=1000)
        limit_symbols = st.number_input("symbol limit", min_value=50, max_value=5000, value=min(500, get_all_tickers().__len__()), step=50)
        run_btn = st.button("run batch", disabled=(mode != "Backtest"))

        # Log display option
        log_tail_lines = st.number_input(
            "max log lines shown per system", min_value=10, max_value=10000, value=500, step=50, key="batch_log_tail_n"
        )

        # Saved results (persist across reruns)
        saved_df = st.session_state.get("Batch_all_trades_df")
        saved_summary = st.session_state.get("Batch_summary_dict")
        saved_capital = st.session_state.get("Batch_capital")
        if saved_df is not None:
            st.markdown("---")
            st.subheader("Saved Batch Results (persisted)")
            if isinstance(saved_summary, dict):
                cols = st.columns(6)
                cols[0].metric("trades", saved_summary.get("trades"))
                cols[1].metric("total pnl", f"{saved_summary.get('total_return', 0):.2f}")
                cols[2].metric("win(%)", f"{saved_summary.get('win_rate', 0):.2f}")
                cols[3].metric("PF", f"{saved_summary.get('profit_factor', 0):.2f}")
                cols[4].metric("Sharpe", f"{saved_summary.get('sharpe', 0):.2f}")
                cols[5].metric("MDD", f"{saved_summary.get('max_drawdown', 0):.2f}")
            st.dataframe(saved_df)
            # Download / Save buttons for saved batch
            import pandas as _pd
            import os as _os
            _ts = _pd.Timestamp.now().strftime("%Y-%m-%d_%H%M")
            st.download_button(
                label="download saved batch trades CSV",
                data=saved_df.to_csv(index=False).encode("utf-8"),
                file_name=f"batch_trades_saved_{_ts}_{int(saved_capital or 0)}.csv",
                mime="text/csv",
                key="download_saved_batch_csv",
            )
            if st.button("save saved batch CSV to disk", key="save_saved_batch_to_disk"):
                out_dir = _os.path.join("results_csv", "batch"); _os.makedirs(out_dir, exist_ok=True)
                trades_path = _os.path.join(out_dir, f"batch_trades_saved_{_ts}_{int(saved_capital or 0)}.csv")
                saved_df.to_csv(trades_path, index=False)
                # summary
                if isinstance(saved_summary, dict):
                    sum_df = _pd.DataFrame([saved_summary])
                    sum_path = _os.path.join(out_dir, f"batch_summary_saved_{_ts}_{int(saved_capital or 0)}.csv")
                    sum_df.to_csv(sum_path, index=False)
                st.success(f"saved to {out_dir}")
            if st.button("clear saved batch results", key="clear_saved_batch"):
                for k in ["Batch_all_trades_df", "Batch_summary_dict", "Batch_capital"]:
                    if k in st.session_state:
                        del st.session_state[k]
                st.experimental_rerun()

        # Saved per-system logs
        st.markdown("---")
        with st.expander("Saved Per-System Logs", expanded=False):
            any_logs = False
            for i in range(1, 8):
                sys_name = f"System{i}"
                logs = st.session_state.get(f"{sys_name}_debug_logs")
                if logs:
                    any_logs = True
                    with st.expander(f"{sys_name} logs", expanded=False):
                        tail = list(map(str, logs))[-int(log_tail_lines):]
                        st.text("\n".join(tail))
            if not any_logs:
                st.info("no saved logs yet")

        if mode != "Backtest":
            st.info("Signal detection mode will be added soon.")

        if run_btn:
            all_tickers = get_all_tickers()
            symbols = all_tickers[: int(limit_symbols)]
            spy_df = get_spy_data_cached()

            overall = []
            sys_progress = st.progress(0)
            sys_log = st.empty()
            total_sys = 7
            done_sys = 0
            batch_ui = UIManager()

            for i in range(1, 8):
                sys_name = f"System{i}"
                sys_log.text(f"{sys_name}: starting...")
                try:
                    mod = __import__(f"strategies.system{i}_strategy", fromlist=[f"System{i}Strategy"])  # type: ignore
                    cls = getattr(mod, f"System{i}Strategy")
                    strat = cls()

                    sys_ui = batch_ui.system(sys_name, title=sys_name)
                    prepared, cands, merged = _prepare_ui(
                        strat,
                        symbols if sys_name != "System7" else ["SPY"],
                        system_name=sys_name,
                        spy_df=spy_df,
                        ui_manager=sys_ui,
                    )
                    if cands is None:
                        sys_log.text(f"{sys_name}: no candidates (skip)")
                        done_sys += 1
                        sys_progress.progress(done_sys / total_sys)
                        continue

                    sys_log.text(f"{sys_name}: running...")
                    res = _run_ui(
                        strat,
                        prepared,
                        cands,
                        capital,
                        system_name=sys_name,
                        ui_manager=sys_ui,
                    )
                    if res is not None and not res.empty:
                        res["system"] = sys_name
                        overall.append(res)
                        with sys_ui.container.expander(f"{sys_name} result", expanded=False):
                            _show_sys_result(res, capital)
                    else:
                        st.info(f"{sys_name}: no trades")
                except Exception as e:  # noqa: BLE001
                    logger.exception("%s error", sys_name)
                    st.exception(e)
                finally:
                    done_sys += 1
                    sys_progress.progress(done_sys / total_sys)

            st.markdown("---")
            st.subheader("All systems summary")
            if overall:
                import pandas as pd

                all_df = pd.concat(overall, ignore_index=True)
                summary, all_df2 = summarize_perf(all_df, capital)
                cols = st.columns(6)
                d = summary.to_dict()
                cols[0].metric("trades", d.get("trades"))
                cols[1].metric("total pnl", f"{d.get('total_return', 0):.2f}")
                cols[2].metric("win(%)", f"{d.get('win_rate', 0):.2f}")
                cols[3].metric("PF", f"{d.get('profit_factor', 0):.2f}")
                cols[4].metric("Sharpe", f"{d.get('sharpe', 0):.2f}")
                cols[5].metric("MDD", f"{d.get('max_drawdown', 0):.2f}")
                st.dataframe(all_df2)

                # Download / Save buttons for current batch output
                _ts2 = pd.Timestamp.now().strftime("%Y-%m-%d_%H%M")
                st.download_button(
                    label="download batch trades CSV",
                    data=all_df2.to_csv(index=False).encode("utf-8"),
                    file_name=f"batch_trades_{_ts2}_{int(capital)}.csv",
                    mime="text/csv",
                    key="download_batch_csv_current",
                )
                if st.button("save batch CSV to disk", key="save_batch_to_disk_current"):
                    import os as _os
                    out_dir = _os.path.join("results_csv", "batch"); _os.makedirs(out_dir, exist_ok=True)
                    trades_path = _os.path.join(out_dir, f"batch_trades_{_ts2}_{int(capital)}.csv")
                    all_df2.to_csv(trades_path, index=False)
                    sum_df = pd.DataFrame([d])
                    sum_path = _os.path.join(out_dir, f"batch_summary_{_ts2}_{int(capital)}.csv")
                    sum_df.to_csv(sum_path, index=False)
                    st.success(f"saved to {out_dir}")

                # Save to session (persist across reruns)
                st.session_state["Batch_all_trades_df"] = all_df2
                st.session_state["Batch_summary_dict"] = d
                st.session_state["Batch_capital"] = capital
            else:
                st.info("no results")

            # Show latest per-system logs after batch run
            st.markdown("---")
            with st.expander("Per-System Logs (latest)", expanded=False):
                any_logs2 = False
                for i in range(1, 8):
                    sys_name = f"System{i}"
                    logs = st.session_state.get(f"{sys_name}_debug_logs")
                    if logs:
                        any_logs2 = True
                        with st.expander(f"{sys_name} logs", expanded=False):
                            tail2 = list(map(str, logs))[-int(log_tail_lines):]
                            st.text("\n".join(tail2))
                if not any_logs2:
                    st.info("no logs to show")

    # Individual tabs (reuse each system's UI assets via app_systemX.main_process)
    for idx, tab in enumerate(tabs[1:], start=1):
        with tab:
            sys_name = f"System{idx}"
            st.subheader(f"{sys_name} backtest")
            try:
                app_mod = __import__(f"app_system{idx}")
                if idx == 1:
                    # System1: reuse cached SPY from integrated layer
                    spy_df = get_spy_data_cached()
                    app_mod.main_process(spy_df=spy_df)
                else:
                    app_mod.main_process()
            except Exception as e:  # noqa: BLE001
                logger.exception("%s tab error", sys_name)
                st.exception(e)


if __name__ == "__main__":
    main()

